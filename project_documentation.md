# STM32F103C8T6 工程说明文档

本文档详细说明了基于STM32F103C8T6单片机的智能控制系统的设计与实现。系统集成了温湿度检测、紫外线感应、红外触发等功能，并支持多种控制模式。文档包含了完整的硬件接口定义、软件功能说明和调试方法，可作为开发和维护的技术参考手册。

## 目录
- [STM32F103C8T6 工程说明文档](#stm32f103c8t6-工程说明文档)
  - [目录](#目录)
  - [文档信息](#文档信息)
  - [修订历史](#修订历史)
  - [系统框图](#系统框图)
    - [1. 系统总体框图](#1-系统总体框图)
    - [2. 信号连接](#2-信号连接)
  - [一、引脚分配](#一引脚分配)
    - [1. 通信接口](#1-通信接口)
    - [2. 传感器接口](#2-传感器接口)
    - [3. 控制输出](#3-控制输出)
    - [4. 按键输入（4x4矩阵键盘）](#4-按键输入4x4矩阵键盘)
    - [5. LED指示](#5-led指示)
  - [二、外设资源使用](#二外设资源使用)
    - [1. 定时器](#1-定时器)
    - [2. ADC](#2-adc)
    - [3. USART](#3-usart)
    - [4. I2C（软件模拟）](#4-i2c软件模拟)
  - [三、系统功能说明](#三系统功能说明)
    - [1. 工作模式](#1-工作模式)
    - [2. 温湿度控制功能](#2-温湿度控制功能)
    - [3. 显示功能（OLED）](#3-显示功能oled)
    - [4. 通信功能](#4-通信功能)
    - [5. 安全保护功能](#5-安全保护功能)
  - [四、编译和调试说明](#四编译和调试说明)
    - [1. 开发环境](#1-开发环境)
    - [2. 项目结构](#2-项目结构)
    - [3. 中断处理](#3-中断处理)
    - [4. 调试方法](#4-调试方法)

## 文档信息
- 文档版本：V1.0
- 创建日期：2025/4/28
- 最后更新：2025/4/28
- 适用项目版本：V1.0.0

## 修订历史
| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| V1.0 | 2025/4/28 | 首次创建，完整记录系统功能和接口 | DK |

## 系统框图

### 1. 系统总体框图
```
+----------------+      +----------------+      +----------------+
|   传感器系统   |      |   STM32F103    |      |    执行系统    |
|----------------|      |----------------|      |----------------|
| DHT11(温湿度)  |----->|                |----->|  风扇(PC15-)   |
| SD12(紫外线)   |----->|                |----->|  UV灯(PA12+)   |
| IR(红外PA7)    |----->|      CPU       |----->|  电机(PWM/IO)  |
+----------------+      |                |----->|  舵机(PWM)     |
                       |                |----->|  蜂鸣器(PC14-)  |
+----------------+     |                |      +----------------+
|    人机接口    |     |                |
|----------------|     |                |      +----------------+
| 矩阵键盘(4x4)  |<--->|                |<---->|    通信系统    |
| OLED(I2C)      |<----|                |<---->| 蓝牙(UART2)    |
| LED指示(GPIO)   |<----|                |<---->| 调试(UART1)    |
+----------------+     +----------------+      +----------------+
```

### 2. 信号连接
- 传感器接口：
  * DHT11 → PB0（单总线）
  * SD12 → PA0（ADC）
  * IR → PA7（外部中断）

- 执行器接口：
  * Fan → PC15（GPIO）
  * UV LED → PA12（GPIO）
  * Motor → PA4/5/6（GPIO+PWM）
  * Servo → PA1（PWM）
  * Buzzer → PC14（GPIO）

- 通信接口：
  * 蓝牙 → PA2/3（UART2）
  * 调试 → PA9/10（UART1）
  * OLED → PB8/9（I2C）

## 一、引脚分配

### 1. 通信接口
| 功能 | 引脚 | 说明 |
|------|------|------|
| USART1-TX | PA9 | 串口通信发送（115200bps） |
| USART1-RX | PA10 | 串口通信接收（115200bps） |
| USART2-TX | PA2 | 蓝牙通信发送（9600bps） |
| USART2-RX | PA3 | 蓝牙通信接收（9600bps） |
| I2C-SCL | PB8 | OLED显示屏时钟线（软件模拟） |
| I2C-SDA | PB9 | OLED显示屏数据线（软件模拟） |

### 2. 传感器接口
| 功能 | 引脚 | 说明 |
|------|------|------|
| DHT11 | PB0 | 温湿度传感器数据线（单总线） |
| SD12 | PA0 | 紫外线传感器ADC输入（0-4095对应0-11级） |
| RED | PA7 | 红外传感器输入（上升下降沿触发） |

### 3. 控制输出
| 功能 | 引脚 | 说明 |
|------|------|------|
| Fan | PC15 | 风扇控制（低电平触发） |
| UV LED | PA12 | 紫外线灯控制（高电平触发） |
| Buzzer | PC14 | 蜂鸣器控制（低电平触发） |
| Servo | PA1 | 舵机控制（TIM2_CH2，50Hz） |
| Motor Direction1 | PA4 | 电机方向控制1（正转高电平） |
| Motor Direction2 | PA5 | 电机方向控制2（反转高电平） |
| Motor Speed | PA6 | 电机速度控制（TIM3_CH1，20KHz PWM） |

### 4. 按键输入（4x4矩阵键盘）
| 功能 | 引脚 | 说明 |
|------|------|------|
| 行线 | PA8-PA11 | 矩阵键盘行扫描（输出，推挽） |
| 列线 | PB12-PB15 | 矩阵键盘列扫描（输入，上拉） |

### 5. LED指示
| 功能 | 引脚 | 说明 |
|------|------|------|
| System LED | PC13 | 系统状态指示灯 |
| LED1 | PA1 | 通用指示灯1（与舵机共用引脚） |
| LED2 | PA2 | 通用指示灯2（与蓝牙TX共用引脚） |

## 二、外设资源使用

### 1. 定时器
| 定时器 | 功能 | 配置 |
|--------|------|------|
| TIM2 | 舵机PWM | 频率50Hz（20ms周期），占空比0.5ms-2.5ms对应0-180度 |
| TIM3 | 电机PWM | 频率20KHz，占空比0-100%控制速度 |
| TIM4 | 系统定时 | 1ms中断用于定时任务 |

### 2. ADC
- ADC1用于紫外线传感器SD12的模拟信号采集
- 时钟72MHz/6=12MHz
- 采样时间55.5个周期
- 12位分辨率（0-4095）
- 转换结果右对齐
- 仅在需要时进行单次转换

### 3. USART
| 串口 | 功能 | 配置 |
|------|------|------|
| USART1 | 调试串口 | 115200波特率，8数据位，1停止位，无校验 |
| USART2 | 蓝牙通信 | 9600波特率，8数据位，1停止位，无校验 |

### 4. I2C（软件模拟）
- 用于OLED显示屏通信（0.96寸，128x64分辨率）
- 时钟线PB8，数据线PB9
- 标准I2C协议，7位地址0x78
- 支持8x16字体，可显示ASCII字符、数字
- 支持显示十进制、十六进制和二进制数

## 三、系统功能说明

### 1. 工作模式
1. **手动模式 (MANUAL)**
   - 通过矩阵键盘直接控制各个设备
   - 按键1/2：蜂鸣器开关
   - 按键3/4：风扇开关
   - 按键5/6：紫外线灯开关
   - 按键7/8/9：电机控制（正转/反转/停止）
   - 按键10/11/12：舵机控制（0°/90°/180°）

2. **自动模式 (AUTO)**
   - 基于温湿度和红外传感器的自动控制
   - 温度>31℃且湿度>61%时，开启风扇和UV灯
   - 检测到红外触发时，开启UV灯2秒并控制舵机转到90°

3. **循环模式 (CYCLE)**
   - 5秒循环工作模式
   - 前5秒：开启风扇、UV灯、电机正转
   - 后5秒：关闭所有设备

4. **蓝牙模式 (BT)**
   - 通过蓝牙APP控制各个设备
   - 支持UV灯、舵机、风扇、电机的独立控制
   - 可接收蓝牙命令切换工作模式

### 2. 温湿度控制功能
- 支持传感器实时测量值和固定值两种模式
- 按键13：切换到固定值1（温度32度，湿度62%）
- 按键14：切换到固定值2（温度25度，湿度40%）
- 按键15：切换回传感器实时测量值
- 在自动模式下用于控制决策

### 3. 显示功能（OLED）
- 第1行：按键值(K:##)、红外状态(R:Y/N)、DHT11状态(D:OK/ERR)
- 第2行：湿度值显示(hm:##.#%)
- 第3行：温度值(T:##.#°C)和紫外线等级(UV:##)
- 第4行：运行时间(T:####s)、蓝牙状态(B:R)、工作模式(M:MN/AU/CY/BT)
  - MN: 手动模式
  - AU: 自动模式
  - CY: 循环模式
  - BT: 蓝牙模式

### 4. 通信功能
1. **蓝牙通信**
   - 发送数据包格式：
     - 帧头(0xA5)
     - 计数值(1字节)
     - UV等级(1字节，0-11)
     - 湿度值(4字节float)
     - 温度值(4字节float)
     - 校验和(1字节)
     - 帧尾(0x5A)
   - 接收数据包格式：
     - 帧头(0xA5)
     - 控制标志(1字节)：
       * Bit7: UV灯开关
       * Bit6: 舵机角度选择(0°/90°/180°)
       * Bit5: 风扇开关
       * Bit4-3: 电机控制(停止/正转/反转)
       * Bit2-0: 工作模式选择
     - 校验和(1字节)
     - 帧尾(0x5A)
   - 固定时间间隔发送传感器数据
   - 随时接收控制命令

2. **串口调试**
   - 波特率115200
   - 支持printf重定向
   - 用于调试信息输出

### 5. 安全保护功能
- DHT11读取失败时保持使用上次有效数据
- 模式切换时自动关闭所有设备
- 红外触发的UV灯有2秒最大工作时间限制
- 温湿度数据支持固定值模式用于测试
- DHT11故障累计3次才显示ERR，避免显示闪烁
- 每100ms采样一次数据，避免频繁读取

## 四、编译和调试说明

### 1. 开发环境
- 编译器：ARMCC
- IDE：Keil uVision5
- 支持VSCode开发

### 2. 项目结构
- User/：用户代码
- DK/：驱动库文件
- Library/：STM32标准外设库
- Start/：启动文件和系统配置

### 3. 中断处理
- TIM4中断（1ms）：
  - 更新系统运行时间计数
  - 处理延时计数器
  - 执行自动模式和循环模式的定时任务
  - 优先级：2-0

- 串口中断：
  - USART1：调试信息处理，优先级1-1
  - USART2：蓝牙数据接收，优先级1-1

- 外部中断：
  - EXTI7（红外传感器）：处理红外触发事件，优先级1-1

### 4. 调试方法
- 串口打印调试信息（115200bps）
- OLED实时显示系统状态（4行信息更新）
- LED状态指示：
  - LED1/2：可自定义指示状态
  - System LED：系统运行指示
- 矩阵按键支持显示当前按键值（1-16）
